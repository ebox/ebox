<chapter id="ch-openvpn">
  <title>Servicio OpenVPN</title>
  <section id="sect-vpn">
    <title>Servicio de Redes Privadas Virtuales</title>
    <para>
      Puedes acceder a la configuración de Redes Privadas Virtuales (VPN) en
      <menuchoice>
	<guimenu>OpenVPN</guimenu>
      </menuchoice>
      .
    </para>
    <para>
    Para crear el servicio VPN, se necesita primero configurar una
    autoridad de certificación. eBox también da cobertura a este
    servicio que puedes crear a través de 
      <menuchoice>
	<guimenu>Autoridad de Certificación</guimenu>
      </menuchoice>
      .
    </para>
    <para>
    El módulo OpenVPN puede configurar a eBox tanto como un servidor
    OpenVPN como cliente. Se pueden poner en marcha tantos
    clientes/servidores como queramos.
    </para>
  </section>
  <section id="sect-typical-scenarios">
    <title>Escenarios típicos</title>
    <para>
      Como VPN es un servicio bastante complicado, ilustramos con dos
      escenarios típicos su configuración con eBox.
    </para>
    <section id="sect-roadwarrior">
	<title>"Road warrior"</title>
	<para>
	  Se puede configurar a eBox para dar soporte a "Road
          Warriors". Esto es, una máquina eBox trabajando como puerta
	  de enlace y como servidor OpenVPN, que tiene una red de 
	  área local (LAN) detrás, permitiendo a clientes en Internet
	  (road warriors) conectarse a dicha red local vía servicio
	  VPN. La siguiente figura puede dar una mejor visión:
	</para>
	<figure id="fig-roadwarrior">
	  <title>Escenario "Road Warrior"</title>
	  <mediaobject>
	    <imageobject>
	      <imagedata fileref="images/road-warrior.png"
			 format="PNG" />
	    </imageobject>
	  </mediaobject>
	</figure>
	<para>
	  Nuestro objetivo es conectar al cliente 3 con los otros 2 
	  clientes lejanos (1 y 2) y estos últimos entre sí.
	</para>
	<para>
	  Para ello, necesitamos crear una "Autoridad de
	  Certificación" y certificados para todos los elementos
	  presentes en el sistema, el servidor OpenVPN y los dos
	  clientes lejanos. Aquí, la máquina eBox actúa también como
	  autoridad de certificación.

	</para>
	<note>
	  <para>
	    Para obtener información detallada sobre el módulo de 
	    Autoridad de Certificación, <link linkend="ch-ca">visitar su propia parte del manual </link>
	  </para>
	</note>
	<para>
	  Una vez tenemos los certificados, deberíamos poner a punto
	  el servidor OpenVPN en eBox en <guilabel>Crear un nuevo
	  servidor</guilabel>. Se deben dar un nombre, un par
	  protocolo/puerto, un certificado (aquel que acabamos de
	  crear previamente) y una subred donde trabajar. Para los 
	  demás elementos se pueden dejar los valores por
          defecto. Como vemos, el servidor OpenVPN estará escuchando
	  en todas las interfaces externas, por tanto debemos poner
	  al menos una de nuestras interfaces como externa vía
	  <menuchoice>
	    <guimenu>Red</guimenu>
	    <guimenuitem>Interfaces</guimenuitem>
	  </menuchoice>
	  . En nuestro escenario sólo se necesitan dos interfaces,
	  uno interna para la LAN y otra externa para escuchar en
	  Internet.
	</para>
	<para>
	  Tras crear el servidor OpenVPN, debemos habilitar el 
	  servicio y guardar los cambios. Luego, comprobar en
	  <guilabel>Estado</guilabel> que un servidor OpenVPN
	  está funcionando.
	</para>
	<para>
	  Tras ello, debemos anunciar redes, dichas redes serán
	  accesibles por los clientes OpenVPN autorizados. Para 
	  conseguirlo, necesitamos redes que sean accesibles desde
	  la máquina eBox. En nuestro escenario, deberemos añadir
	  la red local para hacer visible el cliente 3 a los
	  otros dos clientes.
	</para>
	<para>
	  Es momento de configurar los clientes. Un cliente OpenVPN 
	  puede configurarse con el siguiente fichero de configuración
	  de ejemplo:
	</para>
	<example id="example-conf-file">
	  <title>Fichero ejemplo de configuración de un cliente
	    OpenVPN</title>
	  <programlisting><![CDATA[
client

dev tap
# En la página de Estado, se puede observar la dirección del interfaz
# y el puerto en el que tu servidor OpenVPN está escuchando
remote <direccion_del_interfaz> <puerto>
# También en la misma página se puede ver el protocolo
proto <protocolo>

####
# Todos los certificados deben descargarse del interfaz de eBox 
# para la autoridad de certificación para luego subirse a la máquinas
# clientes. Cada certificado creado debe ser utilizado por una única
# máquina.
####

# Certificado de la Autoridad
ca <fichero_ca_cert>
# Certificado del cliente
cert <fichero_cliente_cert>
# Clave privada del cliente
key <fichero_cliente_clave_privada>

# Otras opciones
comp-lzo
nobind
]]>
	  </programlisting>
	</example>
	<para>
	  Esta configuración ejemplo puede pasarse al demonio OpenVPN
	  con el siguiente comando: <command>openvpn --config
	  filename</command>. Ahora tenemos acceso al cliente 3 desde 
	  los dos clientes remotos. Para conectar entre sí los clientes
	  remotos, necesitamos activar la opción <guilabel>
	  Habilitar conexiones cliente-a-cliente</guilabel> dentro de la configuración
	  del servidor OpenVPN. Para comprobar que la configuración es
	  correcta, observar la tabla de rutas donde las nuevas red
	  anunciadas se han añadido al interfaz virtual   
	  <literal>tapX</literal>.
	</para>
    </section>
    <section id="sect-two-offices">
      <title>Conectar dos oficinas con eBox y OpenVPN</title>
      <para>
	Este segundo escenario trata de mostrar un caso de uso común
	para eBox. Dos oficinas en diferentes redes necesitan estar 
	conectadas a través de una red privada. Para hacerlo, usaremos
	eBox en ambas como puertas de enlace y una como cliente
	OpenVPN y otra como servidora. La siguiente imagen trata de 
	aclarar la situación:
      </para>
      <figure id="fig-ebox-vs-ebox">
	<title>eBox como servidor OpenVPN vs. eBox como cliente OpenVPN </title>
	<mediaobject>
	  <imageobject>
	    <imagedata fileref="images/two-offices.png"
		       format="PNG" />
	  </imageobject>
	</mediaobject>
      </figure>
      <para>
	Nuestro fin es conectar al cliente 1 en la LAN 1 con el
	cliente 2 en la LAN 2 como si estuviesen en la misma red
	local. Por tanto, debemos configurar un servidor OpenVPN
	como hacemos en <xref linkend="sect-roadwarrior" />. Sin
	embargo, se necesita hacer un pequeño cambio habilitando
	la opción <literal>Ofrecer rutas de clientes eBox</literal>
	para intercambiar rutas entre máquinas eBox.
      </para>
      <para>
	Para configurar eBox como un cliente OpenVPN, podemos hacerlo
	a través del botón <guilabel>Crear un nuevo cliente</guilabel>
	dentro del menú <guimenu>OpenVPN</guimenu>. Se deben dar el
	nombre del cliente, la dirección, puerto y protocolo del
	servidor OpenVPN donde está la otra eBox y los certificados
	correspondientes. Se pueden obtener de manera análoga a la
	explicada anteriormente. Cuando salvas los cambios, en el
	sumario, se puede ver un nuevo demonio OpenVPN en la red 2
	ejecutándose como cliente con la conexión objetivo dirigido a
	la otra eBox dentro de la LAN 1.
      </para>
    </section>
  </section>
</chapter>