<suite>
    <name>eBox Samba tests</name>
    <desc>Contains samba-related tests.</desc>

    <scenario>samba.xml</scenario>

    <test type="selenium">
        <name>SetMaster</name>
        <desc>
        Configure eBox as LDAP master and set the password.
        </desc>

        <host var="master-slave" eq="1">ebox-master</host>
        <host var="master-slave" eq="0">ebox-server</host>

        <dir>set-master</dir>
        <var name="PASSWORD" value="master-foobar"/>
    </test>

<!-- if (master/slave) -->

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>EnableUsersEboxMaster</name>
        <desc>
        Enable users module on ebox-master.
        </desc>

        <host>ebox-master</host>
        <dir>enable-users</dir>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>SetSlave</name>
        <desc>
        Configure eBox as LDAP slave of ebox-master and set the password.
        </desc>

        <host>ebox-server</host>
        <dir>set-slave</dir>
        <var name="IP" value="192.168.2.169"/>
        <var name="PASSWORD" value="ebox-foobar"/>
    </test>

<!-- end if -->

    <test type="selenium">
        <name>EnableModules</name>
        <desc>
        Enables network, firewall, users and samba modules.
        </desc>

        <host>ebox-server</host>
        <dir>enable-modules</dir>
    </test>

    <test type="selenium">
        <name>ConfigNetwork</name>
        <desc>
        Set the interface as external.
        </desc>

        <host>ebox-server</host>
        <dir>set-external</dir>
        <var name="IFACE" value="eth2"/>
    </test>

    <test type="selenium">
        <name>DisablePDC</name>
        <desc>
        Disable PDC.
        </desc>

        <host>ebox-server</host>
        <dir>toggle-pdc</dir>
        <var name="PDC_ACTION" value="uncheck"/>
    </test>

    <test type="selenium">
        <name>ChangeDefaultQuota</name>
        <desc>
        Changes the default quota to 1MB.
        </desc>

        <host>ebox-server</host>
        <dir>change-default-quota</dir>

        <var name="QUOTA" value="1"/>
    </test>

    <test type="selenium">
        <name>AddUserFoo</name>
        <desc>
        Create a new user.
        </desc>

        <host var="master-slave" eq="1">ebox-master</host>
        <host var="master-slave" eq="0">ebox-server</host>

        <dir>add-user</dir>

        <var name="USERNAME" value="foo"/>
        <var name="PASSWORD" value="foo"/>
    </test>

    <test>
        <name>TestQuota</name>
        <desc>Try to put a 4MB file in the user share and ensure
        this cannot be done.
        </desc>

        <assert>failed</assert>

        <host>test-client</host>
        <dir>test-write</dir>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foo"/>
        <var name="ERROR" value="NT_STATUS_DISK_FULL"/>
    </test>

    <test type="selenium">
        <name>ChangeUserQuota</name>
        <desc>
        Changes the user quota to 15MB.
        </desc>

        <host>ebox-server</host>
        <dir>set-user-quota</dir>

        <var name="USERNAME" value="foo"/>
        <var name="QUOTA" value="15"/>
    </test>

    <test>
        <name>TestUserShareWrite</name>
        <desc>Puts a file into the created user account</desc>

        <host>test-client</host>
        <dir>test-write</dir>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foo"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestUserShareRead</name>
        <desc>Gets a file into the created user account</desc>

        <host>test-client</host>
        <dir>test-read</dir>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foo"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test type="selenium">
        <name>AddEboxShare</name>
        <desc>
        Adds a share under ebox directory and
        restore quota to 100mb.
        </desc>

        <host>ebox-server</host>
        <dir>add-ebox-share</dir>
        <var name="SHARE" value="foobar"/>
        <var name="SHARE_PATH" value="foobar"/>
        <var name="TYPE" value="ebox"/>
        <var name="TYPE_LABEL" value="Directory under eBox"/>
        <var name="QUOTA" value="100"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareWriteNoPerm</name>
        <desc>Write to a share without perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
        <var name="SHARE" value="foobar"/>
    </test>
    <test>
        <name>TestSmbClientEboxShareReadNoPerm</name>
        <desc>Read from a share without perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
    </test>

    <test type="selenium">
        <name>GrantEboxShareReadWrite</name>
        <desc>
        Grant read/write perms to the created user.
        </desc>

        <host>ebox-server</host>
        <dir>add-share-perms</dir>
        <var name="USER" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="PERM_LABEL" value="Read and write"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareWriteWithReadWrite</name>
        <desc>Write to a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestSmbClientEboxShareReadWithReadWrite</name>
        <desc>Read from a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test type="selenium">
        <name>GrantEboxShareReadOnly</name>
        <desc>
        Grant read only perms to the created user.
        </desc>

        <host>ebox-server</host>
        <dir>update-share-perms</dir>
        <var name="USER" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="PERM_LABEL" value="Read only"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareWriteWithReadOnly</name>
        <desc>Write to a share with ReadOnly perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_ACCESS_DENIED"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareReadWithReadOnly</name>
        <desc>Read from a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareReadWithReadOnlyBadLogin</name>
        <desc>
        Try to read from a share with read/write perms
        with incorrect password.
        </desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="bar"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_LOGON_FAILURE"/>

        <assert>failed</assert>
    </test>

    <test type="selenium">
        <name>AddUserAdmin</name>
        <desc>
        Create a new user.
        </desc>

        <host var="master-slave" eq="1">ebox-master</host>
        <host var="master-slave" eq="0">ebox-server</host>

        <dir>add-user</dir>

        <var name="USERNAME" value="admin"/>
        <var name="PASSWORD" value="admin"/>
    </test>

    <test type="selenium">
        <name>GrantEboxShareAdmin</name>
        <desc>
        Grant administrator perms to the new user.
        </desc>

        <host>ebox-server</host>
        <dir>add-share-perms</dir>
        <var name="USER" value="admin"/>
        <var name="SHARE" value="foobar"/>
        <var name="PERM_LABEL" value="Administrator"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareWriteAdmin</name>
        <desc>Write to a share with admin perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <var name="USER" value="admin"/>
        <var name="PASS" value="admin"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestSmbClientEboxShareReadAdmin</name>
        <desc>Read from a share with admin perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="admin"/>
        <var name="PASS" value="admin"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestSmbClientEboxShareReadAdminBadLogin</name>
        <desc>Read from a share with admin perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="admin"/>
        <var name="PASS" value="badpass"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_LOGON_FAILURE"/>

        <assert>failed</assert>
    </test>

    <test type="selenium">
        <name>AddFileSystemShare</name>
        <desc>
        Adds a file system share.
        </desc>

        <host>ebox-server</host>
        <dir>add-fs-share</dir>
        <var name="SHARE" value="myshare"/>
        <var name="SHARE_PATH" value="/myshare"/>
        <var name="TYPE" value="system"/>
        <var name="TYPE_LABEL" value="File system path"/>
    </test>

    <test>
        <name>TestSmbClientFileSystemShareWriteNoPerm</name>
        <desc>Write to a share without perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
        <var name="SHARE" value="myshare"/>
    </test>
    <test>
        <name>TestSmbClientFileSystemShareReadNoPerm</name>
        <desc>Read from a share without perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
    </test>

    <test type="selenium">
        <name>GrantFileSystemShareReadWrite</name>
        <desc>
        Grant read/write perms to the created user.
        </desc>

        <host>ebox-server</host>
        <dir>add-share-perms</dir>
        <var name="USER" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="PERM_LABEL" value="Read and write"/>
    </test>

    <test>
        <name>TestSmbClientFileSystemShareWriteWithReadWrite</name>
        <desc>Write to a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestSmbClientFileSystemShareWriteWithReadWriteBadLogin</name>
        <desc>Write to a share with read/write perms with bad password</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="bar"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_STATUS_LOGON_FAILURE"/>

        <assert>failed</assert>
    </test>
    <test>
        <name>TestSmbClientFileSystemShareReadWithReadWrite</name>
        <desc>Read from a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test type="selenium">
        <name>GrantFileSystemShareReadOnly</name>
        <desc>
        Grant read only perms to the created user.
        </desc>

        <host>ebox-server</host>
        <dir>update-share-perms</dir>
        <var name="USER" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="PERM_LABEL" value="Read only"/>
    </test>

    <test>
        <name>TestSmbClientFileSystemShareWriteWithReadOnly</name>
        <desc>Write to a share with ReadOnly perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_STATUS_ACCESS_DENIED"/>
    </test>
    <test>
        <name>TestSmbClientFileSystemShareReadWithReadOnly</name>
        <desc>Read from a share with read/write perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test type="selenium">
        <name>GrantFileSystemShareAdmin</name>
        <desc>
        Grant administrator perms to the new user.
        </desc>

        <host>ebox-server</host>
        <dir>add-share-perms</dir>
        <var name="USER" value="admin"/>
        <var name="SHARE" value="myshare"/>
        <var name="PERM_LABEL" value="Administrator"/>
    </test>

    <test>
        <name>TestSmbClientFileSystemShareWriteAdmin</name>
        <desc>Write to a share with admin perms</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <var name="USER" value="admin"/>
        <var name="PASS" value="admin"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_"/>
    </test>
    <test>
        <name>TestSmbClientFileSystemShareReadAdmin</name>
        <desc>Read from a share with admin perms</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <var name="USER" value="admin"/>
        <var name="PASS" value="admin"/>
        <var name="SHARE" value="myshare"/>
        <var name="ERROR" value="NT_"/>
    </test>

    <test type="selenium">
        <name>DeleteEboxShare</name>
        <desc>
        Delete share under eBox and expect confirmation because
        directory is not empty.
        </desc>

        <host>ebox-server</host>
        <dir>delete-ebox-share</dir>
        <var name="SHARE" value="foobar"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareDeletedWrite</name>
        <desc>Write to a share that has been deleted</desc>

        <host>test-client</host>
        <dir>test-write</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
    </test>

    <test>
        <name>TestSmbClientEboxShareDeletedRead</name>
        <desc>Read from a share that has been deleted</desc>

        <host>test-client</host>
        <dir>test-read</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
        <var name="SHARE" value="foobar"/>
        <var name="ERROR" value="NT_STATUS_BAD_NETWORK_NAME"/>
    </test>

    <test>
        <name>TestJoinWithDisabledPDC</name>
        <desc>Test net join with PDC disabled</desc>

        <host>ebox-server</host>
        <dir>test-join</dir>

        <assert>failed</assert>
        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
    </test>

    <test type="selenium">
        <name>EnablePDC</name>
        <desc>
        Enable PDC.
        </desc>

        <host>ebox-server</host>
        <dir>toggle-pdc</dir>
        <var name="PDC_ACTION" value="check"/>
    </test>

    <test>
        <name>TestJoinWithEnabledPDC</name>
        <desc>Test net join with PDC enabled</desc>

        <host>ebox-server</host>
        <dir>test-join</dir>

        <var name="USER" value="foo"/>
        <var name="PASS" value="foo"/>
    </test>

<!-- Aditional master-slave tests -->

    <test>
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveStopApache</name>
        <desc>
        Stop ebox apache on the slave.
        </desc>

        <host>ebox-server</host>
        <dir>apache-updown</dir>
        <var name="ACTION" value="stop"/>
    </test>

    <test type="selenium">
        <name>ChangePassword</name>
        <desc>
        Change a password of a user in the master while
        the slave is down or change it in the only
        ebox if we're not using master/slave.
        </desc>

        <host var="master-slave" eq="1">ebox-master</host>
        <host var="master-slave" eq="0">ebox-server</host>

        <dir>change-password</dir>
        <var name="USERNAME" value="foo"/>
        <var name="PASSWORD" value="bar"/>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveCheckPendingSync</name>
        <desc>
        Check if user foo has operation pending.
        </desc>

        <host>ebox-master</host>

        <dir>check-operation-pending</dir>
        <var name="SLAVE" value="ebox-server"/>
        <var name="USERNAME" value="foo"/>
    </test>

    <test>
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveStartApache</name>
        <desc>
        Start ebox apache on the slave.
        </desc>

        <host>ebox-server</host>
        <dir>apache-updown</dir>
        <var name="ACTION" value="start"/>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveForceSync</name>
        <desc>
        Force sync of operations pending.
        </desc>

        <host>ebox-master</host>

        <dir>force-sync</dir>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveCheckNoPendingSync</name>
        <desc>
        Check if there are no pending operations.
        </desc>

        <host>ebox-master</host>

        <dir>check-no-pending</dir>
    </test>

    <test>
        <name>TestSambaAfterPasswordChanged</name>
        <desc>Checks if the user is </desc>

        <host>test-client</host>
        <dir>test-write</dir>
        <var name="USER" value="foo"/>
        <var name="PASS" value="bar"/>
        <var name="SHARE" value="foo"/>
        <var name="ERROR" value="NT_"/>
    </test>


    <test>
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveStopApache2</name>
        <desc>
        Stop ebox apache on the slave.
        </desc>

        <host>ebox-server</host>
        <dir>apache-updown</dir>
        <var name="ACTION" value="stop"/>
    </test>

    <test type="selenium">
        <name>DeleteUser</name>
        <desc>Deletes an user through the ebox web interface
        </desc>

        <host var="master-slave" eq="1">ebox-master</host>
        <host var="master-slave" eq="0">ebox-server</host>

        <dir>delete-user</dir>
        <var name="USERNAME" value="foo"/>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveCheckPendingSync2</name>MasterSlave
        <desc>
        Check if slavedownuser has operation pending.
        </desc>

        <host>ebox-master</host>

        <dir>check-operation-pending</dir>
        <var name="SLAVE" value="ebox-server"/>
        <var name="USERNAME" value="foo"/>
    </test>

    <test>
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveStartApache2</name>MasterSlave
        <desc>
        Start ebox apache on the slave.
        </desc>

        <host>ebox-server</host>
        <dir>apache-updown</dir>
        <var name="ACTION" value="start"/>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveForceSync2</name>MasterSlave
        <desc>
        Force sync of operations pending.
        </desc>

        <host>ebox-master</host>

        <dir>force-sync</dir>
    </test>

    <test>
        <name>CheckDeleteHome</name>
        <desc>Checks if the home directory has been removed
        after deleting the user.
        </desc>

        <host>ebox-server</host>

        <dir>check-delete-home</dir>
        <var name="USERNAME" value="foo"/>
    </test>

    <test type="selenium">
        <precondition var="master-slave" eq="1"/>

        <name>MasterSlaveCheckNoPendingSync2</name>
        <desc>
        Check if there are no pending operations.
        </desc>

        <host>ebox-master</host>

        <dir>check-no-pending</dir>
    </test>
</suite>
