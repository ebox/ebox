#!/bin/bash

USER=$PAM_USER
USERHOME=/home/samba/users/$USER

CONFIGURED_STAMP=$USERHOME/.ebox-desktop-configured

# We don't do anything if it's already configured
[ -f $CONFIGURED_STAMP ] && exit 0

SERVER=`grep ^host /etc/ldap.conf | cut -d' ' -f2`
PROFILE=$USERHOME/.profile

# Debug stuff
echo "env > $USERHOME/ENV_OUTPUT_DEBUG" >> $PROFILE
echo "id > $USERHOME/ID_OUTPUT_DEBUG" >> $PROFILE

# Pidgin configuration
sed -i "s/USERNAME/$USER/g" $USERHOME/pidgin/accounts.xml
sed -i "s/EBOXDOMAIN/ebox/g" $USERHOME/pidgin/accounts.xml
sed -i "s/USERNAME/$USER/g" $USERHOME/pidgin/blist.xml
sed -i "s/EBOXDOMAIN/ebox/g" $USERHOME/pidgin/blist.xml
mv $USERHOME/pidgin $USERHOME/.purple

# Ekiga configuration
EKIGACONF=$USERHOME/ekiga.gconf
sed -i "s/USERNAME/$USER/g" $EKIGACONF
sed -i "s/SERVER/$SERVER/g" $EKIGACONF
echo "[ -r $EKIGACONF ] && gconftool --load $EKIGACONF" >> $PROFILE
echo "[ -r $EKIGACONF ] && rm $EKIGACONF" >> $PROFILE

# Copy system skel after ebox-desktop setup is done
# This will overwrite our .profile
echo "shopt -s dotglob" >> $PROFILE
echo "cp -r /etc/skel/* $USERHOME/" >> $PROFILE

# Restore .profile ownership
chown $USER: $PROFILE

touch $CONFIGURED_STAMP
