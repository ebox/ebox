#!/bin/bash

LDAP_PASS=`cat /var/lib/ebox/conf/ebox-ldap.passwd`

cd /usr/share/egroupware/setup

./setup-cli.php --install default,ebox

./setup-cli.php --config default,ebox --webserver-url /egroupware

./setup-cli.php --config default,ebox --files-dir /var/lib/egroupware/default/files
./setup-cli.php --config default,ebox --backup-dir /var/lib/egroupware/default/backup
./setup-cli.php --config default,ebox --temp-dir /tmp

./setup-cli.php --config default,ebox --account-auth ldap,ldap --ldap-host "$LDAP_HOST" --ldap-root-dn "$ROOT_DN" --ldap-root-pw "$LDAP_PASS" --ldap-context "$USERS_DN" --ldap-group-context "$GROUPS_DN"

./setup-cli.php --config default,ebox --smtpserver localhost --postfix yes

# Back to the previous directory
cd -

# Set minimum account id
su postgres -c "psql egroupware -c \"INSERT INTO egw_config VALUES ('phpgwapi','account_min_id',2001)\""

# Set default preferences (some egroupware apps doesn't work if they are not set)
su postgres -c "psql egroupware -c \"INSERT INTO egw_preferences VALUES (-2, 'common', 'a:6:{s:12:\\\"template_set\\\";s:6:\\\"jerryr\\\";s:5:\\\"theme\\\";s:6:\\\"jerryr\\\";s:9:\\\"tz_offset\\\";s:1:\\\"0\\\";s:10:\\\"dateformat\\\";s:5:\\\"m/d/Y\\\";s:10:\\\"timeformat\\\";s:2:\\\"24\\\";s:11:\\\"default_app\\\";s:4:\\\"home\\\";}');\""

